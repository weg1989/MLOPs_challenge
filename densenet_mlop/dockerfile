FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install Python 3.10 + pip + uv
RUN apt-get update && apt-get install -y \
    python3.10 python3.10-venv python3-pip wget curl git && \
    pip3 install --upgrade pip uv && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app
COPY . /app

# Create a virtual environment with uv
RUN uv venv /opt/venv --python=python3.10
ENV PATH="/opt/venv/bin:$PATH"

# Install PyTorch with CUDA 12.1 wheels into the venv
RUN uv pip install --python=/opt/venv/bin/python \
    torch==2.5.1+cu121 \
    torchvision==0.20.1+cu121 \
    torchaudio==2.5.1+cu121 \
    --extra-index-url https://download.pytorch.org/whl/cu121

# Install project dependencies into the venv
RUN uv pip install --python=/opt/venv/bin/python -r requirements.txt

# Expose TensorBoard port
EXPOSE 6006

# Healthcheck for TensorBoard
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:6006/ || exit 1

# Run the benchmark suite by default
CMD ["/opt/venv/bin/python", "scripts/densenet_benchmarks_all.py", "--output-dir", "/app/results", "--gpu-enabled", "true"]
